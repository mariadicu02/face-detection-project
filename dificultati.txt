
ğŸ§© DocumentaÈ›ie depanare completÄƒ â€“ Moodle pe Raspberry Pi + Sistem prezenÈ›Äƒ facialÄƒ
------------------------------------------------------------------------------------

ğŸ“Œ ProblemÄƒ: Moodle nu se Ã®ncarcÄƒ local (timeout la http://localhost/moodle)

ğŸ” Simptome:
- Pagina rÄƒmÃ¢nea blocatÄƒ Ã®n browser.
- Eroare: ERR_CONNECTION_TIMED_OUT
- Accesul la http://localhost funcÈ›iona, dar nu È™i http://localhost/moodle.

ğŸ§ª Cauze:
1. Moodle fusese configurat anterior pe altÄƒ reÈ›ea.
2. FiÈ™ierul config.php conÈ›inea o adresÄƒ IP veche È™i invalidÄƒ.
3. Apache funcÈ›iona, dar redirectul spre IP-ul anterior bloca accesul.

âœ… SoluÈ›ie:
1. Verificare IP curent:
   ip a
   â†’ Ex: 192.168.0.101

2. Verificare Apache:
   sudo systemctl status apache2

3. Verificare structurÄƒ fiÈ™iere:
   ls /var/www/html/

4. Editare config.php:
   sudo nano /var/www/html/moodle/config.php
   Linia modificatÄƒ:
   $CFG->wwwroot = 'http://localhost/moodle';

5. Salvare È™i reÃ®ncÄƒrcare â†’ Moodle a funcÈ›ionat corect.

ğŸ” Integrare REST API Moodle â€“ Probleme È™i depanare

1ï¸âƒ£ ProblemÄƒ: HTTP 403 Forbidden
Simptome:
- Mesaj Ã®n script: [âŒ] Eroare HTTP: 403
- Ãn browser: Access denied

CauzÄƒ:
- Protocolul REST nu era activat Ã®n Moodle.

SoluÈ›ie:
- Navigare:
  Site administration > Plugins > Web services > Manage protocols
- Bifare REST â†’ Save changes

2ï¸âƒ£ ProblemÄƒ: Token valid, dar serviciu fÄƒrÄƒ permisiuni
Simptome:
- Scriptul returna eroarea:
  "Expecting value: line 1 column 1 (char 0)"

Diagnostic:
- Tokenul era asociat unui serviciu care nu avea funcÈ›iile necesare.

SoluÈ›ie:
- Navigare:
  Site administration > Server > Web services > External services
- Selectare serviciu (ex: AttendanceService)
- AdÄƒugare manualÄƒ funcÈ›ii:
  - core_webservice_get_site_info
  - mod_attendance_get_sessions
  - mod_attendance_update_user_status

3ï¸âƒ£ ProblemÄƒ: FuncÈ›iile nu apÄƒreau Ã®n rÄƒspunsul JSON
CauzÄƒ:
- FuncÈ›iile REST nu erau Ã®ncÄƒ adÄƒugate serviciului tokenului.

SoluÈ›ie:
- External services > AttendanceService > Add functions
- AdÄƒugare funcÈ›ii lipsÄƒ (ex: mod_attendance_get_user_statuses)

ğŸ§  ProblemÄƒ nouÄƒ: Eroare Ã®n marcarea prezenÈ›ei â€“ invalidparameter

Context:
- Scriptul facial_detection.py recunoaÈ™te corect faÈ›a â†’ obÈ›ine ID-ul studentului È™i al sesiunii.
- Ãn pasul final, marcarea prezenÈ›ei eÈ™ueazÄƒ cu mesajul:
  "Invalid parameter value detected (Missing required key in single structure: studentid)"

Diagnostic:
- Moodle aÈ™teaptÄƒ parametrii Ã®ntr-o structurÄƒ de tip dicÈ›ionar, nu forma updates[0][studentid].

SoluÈ›ie:
- Ãnlocuire cod:
  updates[0][studentid] â†’ updates: [{"studentid": ..., "statusid": ...}]
- Trimitere JSON cu:
  headers={'Content-Type': 'application/json'}, json=data

âš ï¸ Alte probleme tehnice observate

ğŸ¥ Eroare camerÄƒ OpenCV/GStreamer:
- WARN: Could not read from resource.

CauzÄƒ:
- CamerÄƒ neconectatÄƒ sau port GStreamer nefuncÈ›ional.

SoluÈ›ii:
- Confirmare camerÄƒ conectatÄƒ.
- Ãnlocuire cu cv2.VideoCapture(0)

ğŸ“· Calitatea imaginilor pentru recunoaÈ™tere:
Probleme:
- Poze neclare â†’ nerecunoscute

SoluÈ›ii:
- Fotografii frontale, nume format prenume_nume.jpg
- StructurÄƒ studenti.json corectÄƒ

âœ… Rezumat funcÈ›ionare sistem

| ComponentÄƒ         | Status        | ObservaÈ›ii                            |
|--------------------|---------------|----------------------------------------|
| Moodle Local       | âœ… FuncÈ›ional | AdresÄƒ stabilitÄƒ pe localhost          |
| REST API           | âœ… Activat     | FuncÈ›ii complet adÄƒugate              |
| Token              | âœ… Valid       | Asociat AttendanceService             |
| Facial Recognition | âœ… FuncÈ›ional | Poze optimizate, encodings salvate    |
| Marcarea prezenÈ›ei | âœ… OK          | DupÄƒ corectare structurÄƒ JSON         |

ğŸ“¦ RecomandÄƒri mentenanÈ›Äƒ:
- VerificÄƒ config.php la schimbare de reÈ›ea.
- ConfirmÄƒ funcÈ›iile asociate tokenului.
- RuleazÄƒ script test:
  python test_moodle_connection.py
- Pentru loguri:
  tail -f /var/log/apache2/error.log




# ============================
# PASUL 1: Instalare dependente
# ============================
# 1. AsigurÄƒ-te cÄƒ ai urmÄƒtoarele biblioteci instalate:
# pip install opencv-python dlib numpy requests adafruit-circuitpython-pn532
# pip install sqlite3 (doar pentru unele versiuni de Python, altfel e inclus)

# ============================
# PASUL 2: Crearea bazei de date SQLite
# ============================
# Acest script se ruleazÄƒ o singurÄƒ datÄƒ pentru a crea tabelele.
import sqlite3

conn = sqlite3.connect("studenti.db")
c = conn.cursor()

c.execute("""
CREATE TABLE IF NOT EXISTS studenti (
    id INTEGER PRIMARY KEY,
    nume TEXT NOT NULL,
    nfc_uid TEXT
)
""")

c.execute("""
CREATE TABLE IF NOT EXISTS prezente (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    student_id INTEGER,
    data TEXT,
    ora TEXT,
    FOREIGN KEY(student_id) REFERENCES studenti(id)
)
""")

conn.commit()
conn.close()

# ============================
# PASUL 3: Populare baza de date din Moodle
# ============================
# Se adaugÄƒ un script care preia studenÈ›ii Ã®nrolaÈ›i Ã®n curs din Moodle È™i Ã®i insereazÄƒ Ã®n SQLite

import os
import requests
import json
import logging
from datetime import datetime
import sqlite3

MOODLE_URL = "http://192.168.0.101/moodle/webservice/rest/server.php"
MOODLE_TOKEN = os.getenv("MOODLE_TOKEN", "5a987e634310317873b8831b2faeaded")
COURSE_ID = 2

def call_moodle_function(function, params):
    url = f"{MOODLE_URL}?wstoken={MOODLE_TOKEN}&moodlewsrestformat=json&wsfunction={function}"
    try:
        response = requests.post(url, data=params, timeout=5)
        data = response.json()
        return data
    except Exception as e:
        logging.error(f"Eroare Moodle: {e}")
        return {}

def import_students_from_moodle():
    response = call_moodle_function("core_enrol_get_enrolled_users", {"courseid": COURSE_ID})

    conn = sqlite3.connect("studenti.db")
    c = conn.cursor()

    for user in response:
        student_id = user["id"]
        nume = user.get("fullname") or f"User{student_id}"
        nfc_uid = ""  # opÈ›ional
        
        c.execute("INSERT OR IGNORE INTO studenti (id, nume, nfc_uid) VALUES (?, ?, ?)", (student_id, nume, nfc_uid))

    conn.commit()
    conn.close()
    logging.info("StudenÈ›i importaÈ›i cu succes din Moodle.")

import_students_from_moodle()

# ============================
# PASUL 4: Modificare script principal - inregistrare in SQLite
# ============================
# AdaugÄƒ aceastÄƒ funcÈ›ie Ã®n scriptul principal pentru salvarea prezenÈ›ei:

def mark_attendance_sqlite(student_id):
    conn = sqlite3.connect("studenti.db")
    c = conn.cursor()

    now = datetime.now()
    data = now.strftime("%Y-%m-%d")
    ora = now.strftime("%H:%M:%S")

    c.execute("INSERT INTO prezente (student_id, data, ora) VALUES (?, ?, ?)", (student_id, data, ora))
    conn.commit()
    conn.close()
    logging.info(f"[LOCAL âœ…] PrezenÈ›Äƒ Ã®nregistratÄƒ pentru studentul ID {student_id}.")

# Apoi, Ã®n loc de:
# threading.Thread(target=mark_student_attendance, args=(name, student_id)).start()
# foloseÈ™te:
# threading.Thread(target=mark_attendance_sqlite, args=(student_id,)).start()

# ============================
# PASUL 5: Vizualizare live cu DB Browser for SQLite
# ============================
# 1. DescarcÄƒ aplicaÈ›ia: https://sqlitebrowser.org/
# 2. Deschide fiÈ™ierul `studenti.db`
# 3. Mergi la tab-ul "Browse Data"
# 4. SelecteazÄƒ tabelul `prezente` pentru a vedea prezenÈ›ele

# ============================
# PASUL 6: Ce sÄƒ incluzi Ã®n documentaÈ›ie (lucrarea de licenÈ›Äƒ)
# ============================
# - Justificare folosire SQLite: embedded, rapid, fÄƒrÄƒ server separat
# - Structura bazei de date: descrierea tabelelor `studenti` È™i `prezente`
# - Exemplu de interogare: SELECT s.nume, p.data, p.ora FROM prezente p JOIN studenti s ON p.student_id = s.id;
# - Capturi de ecran cu DB Browser for SQLite arÄƒtÃ¢nd prezenÈ›ele
# - Explicarea procesului: recunoaÈ™tere facialÄƒ -> salvare automata Ã®n SQLite

# ============================
# Final
# ============================
# Acum poÈ›i rula aplicaÈ›ia ta principalÄƒ È™i toate prezenÈ›ele vor fi salvate local Ã®n SQLite È™i pot fi vizualizate cu DB Browser.
# Bonus: poÈ›i exporta baza de date ca CSV din DB Browser pentru profesori.




Deci am acest script si vreau sa schimb putin functionalitatea. initial am incercat sa ma folosesc de moodle pentru a pune prezntele studentilor detectati si recunoscuti de camera, dar pentru ca nu am reusit sa pun prezenta din cauza ca moodle nu are functie de set ci doar functii de get, am zis sa fac altfel. sa fac scriptul in asa fel inca sa extraga de pe moodle datele despre studentii inrolati (inclusiv poza lor de probil) si ziua, ora si data sesiunii active de prezenta, iar cand un student e detectat si recunoscut, sa se inregistreze intr o baza de date locala numele prenumele id ul studentului. in cazul in care studenul nu are poza cu el pe moodle, sa i se ofere oportunitatea de a scana cardul de student, si sa i se marcheze prezenta pe baza id ului. mie proful care ma ajuta la liceenta mi a zis ca pot folosi sqlite ca nu e asa complicat. ma poti ajuta cu modificarea codului, sa imi explici si ce faci si sa imi zici ce mai am de facut? as vrea ca in final, atunci cand voi prezenta lucrarea de liceenta sa pot arata live cum e inregistrata prezenta si in baza de date, deci banuiesc ca voi avea nevoie de un site web sau de o aplictaie instlalata pentru a putea urmari asta. in plus, tine cont ca eu acum sunt conectatta pe raspberry pi

Edit
Te ajut sÄƒ modifici scriptul pentru noua funcÈ›ionalitate! ÃÈ›i voi explica pas cu pas ce modificÄƒri trebuie fÄƒcute È™i ce componente noi trebuie adÄƒugate.

Analiza situaÈ›iei actuale È™i planul de modificare
Scriptul actual Ã®ncearcÄƒ sÄƒ marcheze prezenÈ›a direct Ã®n Moodle, dar pentru noua funcÈ›ionalitate vom:

Extrage date din Moodle (studenÈ›i Ã®nrolaÈ›i + poze de profil)
Crea o bazÄƒ de date SQLite localÄƒ pentru prezenÈ›e
AdÄƒuga interfaÈ›Äƒ web pentru monitorizare live
Modifica logica de recunoaÈ™tere sÄƒ foloseascÄƒ datele din Moodle
SÄƒ Ã®ncepem cu modificÄƒrile:


Script Principal Modificat - PrezenÈ›a cu Moodle È™i SQLite
Code 
Acum Ã®È›i voi crea È™i interfaÈ›a web pentru monitorizarea live a prezenÈ›elor:


InterfaÈ›Äƒ Web pentru Monitorizarea PrezenÈ›elor
Code 
Acum Ã®È›i creez template-ul HTML pentru interfaÈ›a web:


Template HTML pentru InterfaÈ›a Web
Interactive artifact 



Continue

Edit

Template HTML pentru InterfaÈ›a Web
Interactive artifactâ€‚âˆ™â€‚Version 2 
Acum Ã®È›i creez È™i un script pentru configurarea iniÈ›ialÄƒ È™i managementul sistemului:


Script de Configurare È™i Management
Code 
Explicarea modificÄƒrilor È™i paÈ™ii urmÄƒtori
Ce am modificat Ã®n scriptul principal:
Structura bazei de date SQLite:
Tabel studenti - informaÈ›ii despre studenÈ›i din Moodle
Tabel sesiuni - sesiunile de prezenÈ›Äƒ din Moodle
Tabel prezente - prezenÈ›ele Ã®nregistrate local
Sincronizare cu Moodle:
Extrage studenÈ›ii Ã®nrolaÈ›i È™i pozele lor de profil
DescarcÄƒ pozele Ã®n directorul poze_moodle/
SincronizeazÄƒ sesiunile de prezenÈ›Äƒ active
RecunoaÈ™terea facialÄƒ:
FoloseÈ™te pozele descÄƒrcate din Moodle
MarcheazÄƒ prezenÈ›a Ã®n baza de date localÄƒ
InterfaÈ›a web:
Server Flask pentru monitorizare live
API endpoints pentru date din baza de date
Actualizare automatÄƒ la fiecare 5 secunde
Ce trebuie sÄƒ faci acum:
1. InstaleazÄƒ dependenÈ›ele:
bash
pip install flask opencv-python dlib numpy requests sqlite3
2. ConfigureazÄƒ Moodle:
ModificÄƒ MOODLE_URL cu URL-ul Moodle-ului tÄƒu
SeteazÄƒ token-ul Moodle: export MOODLE_TOKEN="token_tau_aici"
VerificÄƒ COURSE_ID pentru cursul dorit
3. CreeazÄƒ structura de fiÈ™iere:
proiect/
â”œâ”€â”€ attendance_system.py          # Scriptul principal
â”œâ”€â”€ web_interface.py             # Serverul web
â”œâ”€â”€ setup_manager.py             # Scriptul de configurare
â”œâ”€â”€ templates/
â”‚   â””â”€â”€ index.html              # Template-ul web
â”œâ”€â”€ poze_moodle/                # Pozele descÄƒrcate din Moodle
â”œâ”€â”€ prezenta.db                 # Baza de date SQLite
â””â”€â”€ requirements.txt
4. RuleazÄƒ configurarea:
bash
python setup_manager.py
5. PorneÈ™te sistemul:
bash
# Terminal 1 - Scriptul principal
python attendance_system.py

# Terminal 2 - InterfaÈ›a web
python web_interface.py
6. AcceseazÄƒ interfaÈ›a web:
Local: http://localhost:5000
De pe alt device: http://IP_RASPBERRY:5000
Pentru prezentarea de licenÈ›Äƒ:
DemonstraÈ›ia live:
AratÄƒ cum se detecteazÄƒ studenÈ›ii cu camera
PrezintÄƒ interfaÈ›a web cu actualizarea Ã®n timp real
DemonstreazÄƒ funcÈ›ionalitatea NFC pentru studenÈ›ii fÄƒrÄƒ poze
Monitorizarea bazei de date:
InterfaÈ›a web afiÈ™eazÄƒ statistici live
PoÈ›i vedea Ã®n timp real cine a fost marcat prezent
DiferenÈ›ierea Ã®ntre detectarea prin camerÄƒ È™i NFC
FuncÈ›ii suplimentare:
Exportul datelor din baza de date
Rapoarte de prezenÈ›Äƒ
Integrarea cu sistemul de note
ÃntrebÄƒri pentru tine:
Ai acces la API-ul Moodle È™i È™tii cum sÄƒ obÈ›ii token-ul?
Camera È™i modulul NFC funcÈ›ioneazÄƒ pe Raspberry Pi?
Vrei sÄƒ adaug È™i funcÈ›ionalitÄƒÈ›i de export/raportare?
Ãmi spui ce probleme Ã®ntÃ¢mpini È™i te ajut sÄƒ le rezolvÄƒm!





. Configurarea iniÈ›ialÄƒ
Ai instalat dependenÈ›ele necesare pentru Flask, OpenCV, dlib, SQLite, etc.:

bash
pip install flask opencv-python dlib numpy requests sqlite3
Ai creat fiÈ™ierele necesare pentru proiect, inclusiv:

proiect/
â”œâ”€â”€ attendance_system.py     # Scriptul principal
â”œâ”€â”€ web_interface.py        # Serverul web
â”œâ”€â”€ setup_manager.py        # Scriptul de configurare
â”œâ”€â”€ templates/
â”‚   â””â”€â”€ index.html         # Template-ul web
â”œâ”€â”€ poze_moodle/           # Pozele descÄƒrcate din Moodle
â”œâ”€â”€ prezenta.db            # Baza de date SQLite
â””â”€â”€ requirements.txt
Ai configurat Moodle pentru sincronizare È™i preluare automatÄƒ a studenÈ›ilor È™i a sesiunilor.

2. Pornirea serverului Flask
Ai rulat serverul Flask cu:

bash
python web_interface.py
Ai verificat mesajele din terminal pentru a confirma cÄƒ aplicaÈ›ia ruleazÄƒ corect:

Running on all addresses (0.0.0.0)
Running on http://127.0.0.1:5000
Running on http://192.168.0.101:5000
3. Depanarea problemei "This site can't be reached"
Ai verificat URL-ul corect:

DacÄƒ accesai de pe acelaÈ™i dispozitiv, foloseai http://127.0.0.1:5000

DacÄƒ accesai de pe alt dispozitiv, foloseai http://192.168.0.101:5000

Ai verificat firewall-ul pe Raspberry Pi:

bash
sudo ufw allow 5000
Ai testat conexiunea dintre dispozitive prin ping 192.168.0.101

Ai verificat dacÄƒ existÄƒ un alt serviciu care ocupÄƒ portul 5000:

bash
sudo netstat -tulnp | grep 5000
Ai verificat conÈ›inutul paginii index.html, care era gol iniÈ›ial.

4. AdÄƒugarea conÈ›inutului Ã®n index.html
Ai adÄƒugat un script JavaScript care Ã®ncarcÄƒ lista de studenÈ›i de la API:

html
<script>
    async function loadStudents() {
        const response = await fetch('/api/students');
        const students = await response.json();
        const list = document.getElementById('student-list');

        list.innerHTML = students.map(student => `
            <li>${student.nume} ${student.prenume} - ${student.email}</li>
        `).join('');
    }

    window.onload = loadStudents;
</script>
Ai confirmat cÄƒ datele sunt preluate corect, accesÃ¢nd direct API-ul:

http://192.168.0.101:5000/api/students
5. Verificarea bazei de date SQLite
Ai testat manual dacÄƒ baza de date conÈ›ine studenÈ›i:

python
import sqlite3
conn = sqlite3.connect("prezenta.db")
cursor = conn.cursor()
cursor.execute("SELECT * FROM studenti")
print(cursor.fetchall())
conn.close()
DacÄƒ baza de date era goalÄƒ, trebuia reimportatÄƒ lista de studenÈ›i.

Acum ai un sistem funcÈ›ional! ğŸ“Œ DacÄƒ vrei sÄƒ documentezi procesul, poÈ›i folosi aceastÄƒ recapitulare Ã®ntr-un README sau Ã®ntr-un ghid de instalare. Ai nevoie de ajutor cu altceva?

